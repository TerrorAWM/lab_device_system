<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预约审批 - 管理后台</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/fontawesome/css/all.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <style>
        .approval-chain {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .approval-node {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .approval-node.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .approval-node.approved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .approval-node.rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .approval-node.waiting {
            background: #e2e3e5;
            color: #6c757d;
            border: 1px solid #d6d8db;
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <aside class="sidebar"></aside>
        <div class="main-content">
            <header class="top-nav"></header>
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="page-title mb-0">预约审批</h1>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>申请人</th>
                                        <th>身份</th>
                                        <th>设备</th>
                                        <th>日期/时段</th>
                                        <th>用途</th>
                                        <th>审批进度</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="reservationList">
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 驳回模态框 -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">驳回预约</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="rejectId">
                    <div class="mb-3">
                        <label class="form-label">驳回原因</label>
                        <textarea class="form-control" id="rejectReason" rows="3" placeholder="请填写驳回原因..."
                            required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBtn">确认驳回</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/ui.js"></script>
    <script src="../js/common.js"></script>
    <script>
        // 初始化
        CommonUI.init('reservation', true);

        const admin = Auth.getUser(true);
        let currentRejectId = null;

        const userTypeLabels = {
            'teacher': '教师',
            'student': '学生',
            'external': '校外人员'
        };

        const roleLabels = {
            'advisor': '导师',
            'device': '设备管理员',
            'supervisor': '实验室负责人',
            'finance': '财务'
        };

        // 加载待审批列表
        async function loadReservations() {
            try {
                const result = await API.get('reservation.php?action=pending', {}, true);
                const list = document.getElementById('reservationList');

                if (result.code === 0 && result.data.items) {
                    renderReservations(result.data.items);
                } else {
                    list.innerHTML = `<tr><td colspan="8" class="text-center py-5 text-danger">${result.message || '加载失败'}</td></tr>`;
                }
            } catch (error) {
                console.error('加载预约列表失败:', error);
                document.getElementById('reservationList').innerHTML =
                    `<tr><td colspan="8" class="text-center py-5 text-danger">网络请求失败</td></tr>`;
            }
        }

        function renderReservations(items) {
            const list = document.getElementById('reservationList');

            if (items.length === 0) {
                list.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">暂无待审批的预约</td></tr>';
                return;
            }

            list.innerHTML = items.map(r => {
                const userTypeLabel = userTypeLabels[r.user_type] || r.user_type;

                // 解析审批进度
                let approvals = {};
                try {
                    approvals = r.approvals ? JSON.parse(r.approvals) : {};
                } catch (e) {
                    console.error('解析审批进度失败:', e);
                }

                // 生成审批链显示
                const approvalChain = Object.entries(approvals).map(([role, data]) => {
                    const roleName = roleLabels[role] || role;
                    const statusClass = data.status || 'waiting';
                    const statusText = getStatusText(data.status);
                    return `<span class="approval-node ${statusClass}">${roleName}: ${statusText}</span>`;
                }).join('');

                // 判断是否可以审批
                const canApprove = checkCanApprove(r, admin.role, approvals);

                // 生成操作按钮
                let actions = '<span class="text-muted">-</span>';
                if (canApprove) {
                    actions = `
                        <button class="btn btn-sm btn-success me-1" onclick="approve(${r.id})">
                            <i class="fas fa-check"></i> 批准
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="openRejectModal(${r.id})">
                            <i class="fas fa-times"></i> 驳回
                        </button>
                    `;
                }

                return `
                    <tr>
                        <td>${r.id}</td>
                        <td>${r.user_name || '-'}</td>
                        <td><span class="badge bg-info">${userTypeLabel}</span></td>
                        <td>${r.device_name || '-'}<br><small class="text-muted">${r.model || ''}</small></td>
                        <td>${r.reserve_date || '-'}<br><small class="text-muted">${r.time_slot || ''}</small></td>
                        <td><small>${r.purpose || '-'}</small></td>
                        <td><div class="approval-chain">${approvalChain || '-'}</div></td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusText(status) {
            const map = {
                'pending': '待审',
                'approved': '已批',
                'rejected': '驳回',
                'waiting': '等待'
            };
            return map[status] || status;
        }

        function checkCanApprove(reservation, adminRole, approvals) {
            // 根据管理员角色和审批流程判断是否可以审批
            const userType = reservation.user_type;

            // 实验室负责人：只审批校外人员，且需要设备管理员已批准
            if (adminRole === 'supervisor') {
                if (userType !== 'external') return false;
                const supervisorNode = approvals['supervisor'];
                const deviceNode = approvals['device'];
                return supervisorNode && supervisorNode.status === 'pending' &&
                    deviceNode && deviceNode.status === 'approved';
            }

            // 设备管理员：可以审批所有类型
            if (adminRole === 'device') {
                const deviceNode = approvals['device'];
                if (!deviceNode || deviceNode.status !== 'pending') return false;

                // 学生需要导师先批准
                if (userType === 'student') {
                    const advisorNode = approvals['advisor'];
                    return advisorNode && advisorNode.status === 'approved';
                }
                return true;
            }

            // 财务：只审批校外人员，且需要设备管理员和负责人都已批准，并且已付款
            if (adminRole === 'finance') {
                if (userType !== 'external') return false;
                const financeNode = approvals['finance'];
                const deviceNode = approvals['device'];
                const supervisorNode = approvals['supervisor'];

                if (!financeNode || financeNode.status !== 'pending') return false;
                if (!deviceNode || deviceNode.status !== 'approved') return false;
                if (!supervisorNode || supervisorNode.status !== 'approved') return false;

                // 检查是否已付款
                return reservation.payment_status === 'paid';
            }

            return false;
        }

        async function approve(id) {
            if (!confirm('确定要批准这个预约吗?')) return;

            try {
                const result = await API.post('reservation.php?action=approve', { id }, true);
                if (result.code === 0) {
                    UI.showToast('审批成功');
                    loadReservations();
                } else {
                    UI.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('审批失败:', error);
                UI.showToast('网络请求失败', 'error');
            }
        }

        function openRejectModal(id) {
            currentRejectId = id;
            document.getElementById('rejectReason').value = '';
            const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
            modal.show();
        }

        document.getElementById('confirmRejectBtn').addEventListener('click', async () => {
            const reason = document.getElementById('rejectReason').value.trim();

            if (!reason) {
                UI.showToast('请填写驳回原因', 'warning');
                return;
            }

            try {
                const result = await API.post('reservation.php?action=reject', {
                    id: currentRejectId,
                    reason: reason
                }, true);

                if (result.code === 0) {
                    UI.showToast('已驳回');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
                    modal.hide();
                    loadReservations();
                } else {
                    UI.showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('驳回失败:', error);
                UI.showToast('网络请求失败', 'error');
            }
        });

        // 初始加载
        loadReservations();
    </script>
</body>

</html>