<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收费管理 - 管理后台</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/fontawesome/css/all.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>

<body>
    <div class="main-wrapper">
        <aside class="sidebar"></aside>
        <div class="main-content">
            <header class="top-nav"></header>
            <div class="container-fluid">
                <h1 class="page-title">收费管理</h1>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-success text-white text-center p-3 mb-3">
                            <div class="h3 mb-0" id="totalPaid">¥0</div>
                            <div class="small">已收费用</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-white text-center p-3 mb-3">
                            <div class="h3 mb-0" id="totalUnpaid">¥0</div>
                            <div class="small">待收费用</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>用户</th>
                                        <th>费用描述</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>支付时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentList">
                                    <tr>
                                        <td colspan="6" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/ui.js"></script>
    <script src="../js/common.js"></script>
    <script>
        // 初始化
        CommonUI.init('payment', true);

        // 加载缴费列表
        async function loadPayments() {
            const result = await API.get('payment.php', {}, true);
            const list = document.getElementById('paymentList');

            if (result.code === 0) {
                renderPayments(result.data);
            } else {
                list.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-danger">${result.message}</td></tr>`;
            }
        }

        function renderPayments(data) {
            const list = document.getElementById('paymentList');
            const items = data.items || [];

            document.getElementById('totalPaid').textContent = `¥${data.stats.total_paid || 0}`;
            document.getElementById('totalUnpaid').textContent = `¥${data.stats.total_unpaid || 0}`;

            if (items.length === 0) {
                list.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">暂无缴费记录</td></tr>';
                return;
            }

            list.innerHTML = items.map(item => {
                const statusClass = {
                    'pending': 'badge-warning',
                    'paid': 'badge-success',
                    'refunded': 'badge-secondary'
                }[item.status] || 'badge-info';

                const statusText = {
                    'pending': '待支付',
                    'paid': '已支付',
                    'refunded': '已退款'
                }[item.status] || item.status;

                let actions = '-';
                if (item.status === 'pending') {
                    actions = `
                        <button class="btn btn-sm btn-success" onclick="confirmPayment(${item.id})">
                            <i class="fas fa-check-circle me-1"></i> 确认收款
                        </button>
                    `;
                }

                return `
                    <tr>
                        <td>
                            <div class="fw-bold">${item.user_name}</div>
                            <div class="small text-muted">${item.username || ''}</div>
                        </td>
                        <td>${item.description || '-'}</td>
                        <td class="text-primary fw-bold">¥${item.amount}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>${item.pay_time || '-'}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        // 确认收款
        async function confirmPayment(id) {
            if (!confirm('确定要手动确认该笔费用的收款吗？')) return;

            try {
                const result = await API.post('payment.php?action=mark_paid', { payment_id: id }, true);
                if (result.code === 0) {
                    UI.showToast('收款确认成功');
                    loadPayments();
                } else {
                    UI.showToast(result.message, 'error');
                }
            } catch (error) {
                UI.showToast('网络请求失败', 'error');
            }
        }

        loadPayments();
    </script>
</body>

</html>